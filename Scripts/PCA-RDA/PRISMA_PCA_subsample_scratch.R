# PRISMA PCA comparisons

## Load libraries
library(sp)
library(raster)
library(tidyverse)
library(plyr)

# Load list of scenes

flist = dir("Data/PRISMA/L2W_vnorm/lake")
#Initialize storage for variances and components
vars = tibble()
lds = tibble()

## ONLY NEED TO RUN ONCE AND THEN CAN LOAD COMPILED CSV IN LINE BELOW (COMMENT THE REST OUT)
# compile PRISMA scenes to one common file
# PRISMA lake clipped data

# #Load first file and add to PRISMA_lake that will eventually contain all PRISMA lake data
prisma <- read.csv(file.path("Data/PRISMA/L2W_vnorm/lake",flist[1]))
date = flist[1]
PRISMA_lake <- cbind(date,prisma)
for(i in 2:length(flist)){
  prisma <- read.csv(file.path("Data/PRISMA/L2W_vnorm/lake",flist[i]))
  date = flist[i]
  temp <- cbind(date,prisma)
  PRISMA_lake <- rbind.fill(PRISMA_lake,temp)
}
# 
PRISMA_lake <- PRISMA_lake %>%
  mutate(date = substr(date,8,17))

#export summary file
# write.csv(PRISMA_lake,'Data/PRISMA/PRISMA_lake_compiled.csv')

## Load compiled csv
# MAKE SURE YOU PULL PRISMA_lake_compiled off Google Drive: 
# https://drive.google.com/drive/u/1/folders/1z6HNn4lAW20FnxJWGRZyuyDgpvSD1sYu
# And save in Data/PRISMA
PRISMA_lake <- read.csv('Data/PRISMA/PRISMA_lake_compiled.csv')



## Subsample
# subsample 10% PRISMA data because 
# Critical Scale of Variability ~100m
# PRISMA pixels are 30m, so 3x3 grid of PRISMA pixels is ~100x100m 
# Which means we subsample 1/9 = 11.1% so 10% is fine




  
# read data
  dat = read_csv(paste0("Data/PRISMA/lake/", flist[i])) %>% 
  dplyr::select(-aot_550, -contains("rhot")) %>% #remove unneeded columns (TOA radiance)
  rename("id" = `...1`) %>% # clean up column names
  sf::st_as_sf(coords = c("x", "y")) #convert to SpatialPointsDataFrame

#convert to raster
  dat_ras = raster(dat, resolution = c(1,1)) #each point becomes one raster pixel
  #trim to reasonable spectral range. this is for 450:850nm
  colnames = names(dat)[which(names(dat)=="rhos_453"):which(names(dat)=="rhos_849")]
  #fill the raster with data from each band
  dat_ras = rasterize(dat, dat_ras, field = colnames)
  
# run pca
  rpc = rasterPCA(dat_ras, spca = T #, nSamples = ncell(dat_ras)/10 #can uncomment this to subsample and run faster
                  )
  summary(rpc$model) #prints loadings
  screeplot(rpc$model) #shows variance represented by each component
  ggRGB(rpc$map, 1,2,3, stretch = "lin") #maps the top 3 components
  ggsave(paste0("CO_ignore/",img_date,".png")) #change filepath if you want to save these images

# get variances represented by each PC
  variances = as_tibble(rpc$model$sdev^2, rownames = "component") %>% #convert SD to variance
    mutate(proportion = value/sum(value), #proportion of total variance represented
           img_date = img_date) #add image information in a separate column
# decide how many components to retain
  variances = variances %>% 
    filter(proportion >= 0.01) #just keep those representing at least 1% of variance
    #slice_head(n = (nrow(variances[variances$proportion >= 0.01,])+1)) #or keep those plus one
  
# get loadings for each variance
  loadings = rpc$model$loadings[,1:nrow(variances)] %>% #only keep the ones that have been retained
    as_tibble(rownames = "band") %>% 
    janitor::clean_names() %>%
    pivot_longer(cols = starts_with("comp")) %>% #this will cause an error if only retaining one PC - just comment out this line and fix it manually for that case
    mutate(band = as.numeric(str_remove(band, "rhos_")), #format wavelengths for plotting
           img_date = img_date) #tag with image date
  
# plot loadings  
  ggplot(loadings, aes(x = band, y = value))+
    theme_bw()+
    geom_line(aes(group = name, color = name))+
    scale_color_discrete(name = "Component")+
    labs(x = "Wavelength", y = "Loading")

# save information from this image
  vars = bind_rows(vars, variances)
  lds = bind_rows(lds, loadings)
}

# save information to files
# write_csv(lds, "CO_ignore/prisma_PCA_loadings.csv")
# write_csv(vars, "CO_ignore/prisma_PCA_variances.csv")

#plot all PC loadings

lds = lds %>% 
  filter(img_date!="orrected.z")
lds %>% 
  mutate(grp = paste(name, img_date),
         #following line is to group the panels
         cat = case_when(name %in% c("comp_1", "comp_2") ~ "PC 1, 2",
                         name %in% c("comp_4", "comp_5") ~ "PC 4, 5",
                         name %in% c("comp_6", "comp_7") ~ "PC 6, 7",
                         T ~ "PC 3")) %>% 
  ggplot(aes(x = band, y = value))+
  geom_line(aes(group = grp, color= img_date, lty = name))+
  scale_linetype_manual(values = c(1,2,1,2,1,2,1), guide = "none")+
#  facet_wrap(~ cat)+
  facet_wrap(~name)+
  scale_color_discrete(name = "Image Date")+
  labs(x = "Wavelength", y = "Loading", title = "PRISMA: all PCs over 1% variance")+
  theme_bw()
  
ggsave("Outputs/PCA_outputs/PRISMA/loadings_by_component.png")

lds %>% 
  mutate(grp = paste(name, img_date)) %>% 
  ggplot(aes(x = band, y = value))+
  geom_line(aes(group = grp, color= name))+
 # scale_linetype_manual(values = c(1,2,1,2,1,2,1), guide = "none")+
  #  facet_wrap(~ cat)+
  facet_wrap(~img_date)+
  scale_color_discrete(name = "PC")+
  labs(x = "Wavelength", y = "Loading", title = "PRISMA: all PCs over 1% variance")+
  theme_bw()

ggsave("Outputs/PCA_outputs/PRISMA/loadings_by_date.png")

#denoise
lds %>% 
  filter(name != "comp_5",
         name != "comp_4" | img_date %in% c("2022_06_16", "2022_07_27"),
         name != "comp_6" | img_date != "2022_06_16") %>% 
  mutate(grp = paste(name, img_date)) %>% 
  ggplot(aes(x = band, y = value))+
  geom_line(aes(group = grp, color= name))+
  # scale_linetype_manual(values = c(1,2,1,2,1,2,1), guide = "none")+
  #  facet_wrap(~ cat)+
  facet_wrap(~img_date)+
  scale_color_discrete(name = "PC")+
  labs(x = "Wavelength", y = "Loading", title = "PRISMA: all PCs over 1% variance")+
  theme_bw()

ggsave("Outputs/PCA_outputs/PRISMA/loadings_bydate_denoised.png")

## scratch -- transparancy by weight
vars = read_csv("Outputs/PCA_outputs/PRISMA/prisma_PCA_variances.csv") %>% 
  mutate(component = component %>% str_replace("Comp.", "comp_")) %>% 
  dplyr::select(-value)

data = lds %>% 
  left_join(vars, by = c("name" = "component", "img_date"))

data %>% 
  mutate(grp = paste(name, img_date),
         #following line is to group the panels by shape
         cat = case_when(name %in% c("comp_1", "comp_2") ~ "PC 1, 2",
                         name %in% c("comp_4", "comp_5") ~ "PC 4, 5",
                         name %in% c("comp_6", "comp_7") ~ "PC 6, 7",
                         T ~ "PC 3"))%>% 
  ggplot(aes(x = band, y = value))+
  geom_line(aes(group = grp, color= img_date, alpha = sqrt(sqrt(proportion))))+
  facet_wrap(~ name)+
  scale_color_discrete(name = "Image Date")+
  scale_alpha(name = "Prop. Var \nExplained", range = c(0, 1))+
  labs(x = "Wavelength", y = "Loading", title = "PRISMA: all PCs at/over 1% variance")+
  theme_bw()
